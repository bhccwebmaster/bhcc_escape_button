<?php

/**
 * @file
 * Contains code to refill escape button caches when cache has been cleared.
 */

use Drupal\Core\Site\Settings;
use Drupal\Core\Url;
use Drupal\node\Entity\Node;
use GuzzleHttp\Client;
use GuzzleHttp\Exception\RequestException;

/**
 * Rebuild data based upon refreshed caches.
 *
 * This hook retrieved the escape button module history pages
 * so that they are stored in cache and ready to use immediately
 * when the exit button is used.
 */
function bhcc_escape_button_rebuild() {

  $historyItems = [];
  $host = '';

  $host = Settings::get('bhcc_host_uri') ?? \Drupal::request()->getSchemeAndHttpHost();

  // If not uri is provided, exit.
  if ($host == 'http://default') {
    return FALSE;
  }

  // Check the home page is available - if not exit.
  try {
    $client = new Client();
    $client->get($host);
  }
  catch (Exception $e) {
    \Drupal::logger('bhcc escape button - cache rebuild')->warning("The requested domain (' . $host .  ') is not available:- " . $e->getMessage());
    return FALSE;
  }

  // Get the list of history items.
  $entity_type_manager = \Drupal::entityTypeManager();
  $escape_buttons = $entity_type_manager->getStorage('block')->loadByProperties([
    'plugin' => 'escape_button_block',
  ]);

  foreach ($escape_buttons as $escape_button) {

    if ($escape_button) {
      $settings = $escape_button->get('settings');
      $historyItems = $settings['history'];
    }
    // @todo test if $historyItems[] is emtpy or null
    // cycle through and request to get them cached
    foreach ($historyItems as $historyNodeID) {
      Node::load($historyNodeID);
      try {
        $client = new Client();
        $current_url = Url::fromRoute('entity.node.canonical', ['node' => $historyNodeID], ['absolute' => FALSE])->toString();
        $client->get($host . $current_url);
        \Drupal::logger('bhcc escape button - cache rebuild')->notice('Cache refreshed for node:=' . $historyNodeID);      
      }
      catch (Exception $e) {
        \Drupal::logger('bhcc escape button - cache rebuild')->error('node:=' . $historyNodeID . ', ' . $e->getMessage());
      }
    }
  }
}
